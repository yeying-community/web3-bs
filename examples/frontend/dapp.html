<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>YeYing Dapp Demo</title>
    <style>
      html, body {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
      }
      :root {
        color-scheme: light;
        font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
        background: #f6f7fb;
        color: #1f2937;
      }
      body {
        margin: 0;
        padding: 0;
        background: #f6f7fb;
      }
      .page {
        height: 100vh;
        padding: 24px;
        box-sizing: border-box;
        overflow: hidden;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        gap: 20px;
        align-items: stretch;
        height: 100%;
      }
      .main-pane,
      .log-pane {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        height: 100%;
      }
      .main-pane {
        flex: 2;
        min-width: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }
      .log-pane {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 12px;
      }
      .header-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .header-actions .row {
        margin-bottom: 0;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 22px;
      }
      p {
        margin: 0 0 16px;
        color: #475569;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        flex: 1 1 260px;
      }
      label {
        font-size: 13px;
        color: #475569;
      }
      input, textarea, select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 12px;
        font-size: 14px;
        font-family: inherit;
      }
      button {
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        background: #2563eb;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }
      button.secondary {
        background: #0f172a;
      }
      button.outline {
        background: #fff;
        color: #2563eb;
        border: 1px solid #2563eb;
      }
      button.small {
        padding: 6px 10px;
        font-size: 12px;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      pre {
        background: #0f172a;
        color: #e2e8f0;
        padding: 12px;
        border-radius: 8px;
        font-size: 12px;
        overflow: auto;
      }
      .log-pane pre {
        flex: 1;
        min-height: 0;
      }
      .log-pane h3 {
        margin-top: 0;
      }
      .status {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
        font-size: 14px;
        margin-bottom: 16px;
      }
      .status-row {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 8px;
        align-items: center;
      }
      .status-row span {
        color: #64748b;
      }
      .status-row.hidden {
        display: none;
      }
      .status-slot {
        margin-top: 16px;
      }
      .badge {
        display: inline-block;
        padding: 0;
        border-radius: 0;
        background: transparent;
        color: inherit;
        font-size: 14px;
        font-weight: 500;
      }
      .copyable {
        cursor: pointer;
      }
      .note {
        font-size: 12px;
        color: #64748b;
      }
      button.step-btn::before {
        content: attr(data-step) ".";
        margin-right: 6px;
        font-weight: 700;
        color: #e2e8f0;
      }
      button.step-btn.outline::before {
        color: #2563eb;
      }
      button.step-btn.secondary::before {
        color: #e2e8f0;
      }
      .backend-grid {
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-bottom: 16px;
      }
      .backend-item {
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 10px 12px;
        background: #f8fafc;
        display: grid;
        grid-template-columns: 160px 1fr auto;
        gap: 10px;
        align-items: center;
      }
      .backend-item h4 {
        margin: 0;
        font-size: 13px;
      }
      .backend-item .meta {
        font-size: 12px;
        color: #475569;
        line-height: 1.4;
      }
      .backend-item code {
        font-size: 11px;
        word-break: break-all;
      }
      @media (max-width: 960px) {
        .backend-item {
          grid-template-columns: 1fr;
          gap: 8px;
        }
      }
      .section {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        background: #ffffff;
      }
      .section h2 {
        margin: 0 0 8px;
        font-size: 16px;
      }
      .section .hint {
        margin-bottom: 12px;
        font-size: 12px;
        color: #64748b;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin: 12px 0 16px;
      }
      .tab-button {
        border: 1px solid #cbd5f5;
        background: #eff6ff;
        color: #1e40af;
        padding: 8px 12px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 12px;
      }
      .tab-button.active {
        background: #1e40af;
        color: #fff;
        border-color: #1e40af;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .tab-body {
        flex: 1;
        min-height: 0;
        overflow-y: auto;
      }
      @media (max-width: 960px) {
        .container {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="container">
      <div class="main-pane">
        <div class="header">
          <div>
            <h1>YeYing Dapp Demo</h1>
            <p>模拟 Dapp 连接 YeYing 钱包并完成登录。</p>
          </div>
        </div>

      <div class="tabs">
        <button class="tab-button active" data-tab="wallet">连接钱包</button>
        <button class="tab-button" data-tab="siwe">单后端登录 (SIWE)</button>
        <button class="tab-button" data-tab="ucan-multi">多后端登录 (UCAN)</button>
        <button class="tab-button" data-tab="ucan-dapp">DAPP 登录 (UCAN + WebDAV)</button>
      </div>

      <div class="tab-body">
      <div class="tab-content active" data-tab="wallet">
        <div class="section">
          <div class="hint">检测 Provider 并连接钱包账号。</div>
          <div class="row">
            <button id="detectBtn" class="step-btn" data-step="1" title="检测是否注入钱包 Provider（如 YeYing/MetaMask）">Detect Provider</button>
            <button id="connectBtn" class="secondary step-btn" data-step="2" title="请求钱包授权并返回当前账号">Connect Wallet</button>
          </div>
          <div class="note">提示：切换账号请在钱包内切换。</div>
        </div>
        <div class="status-slot" data-status-slot="wallet">
          <div class="status" id="statusPanel">
            <div class="status-row" data-key="provider">
              <span>Provider</span><div id="providerStatus" class="badge">Not detected</div>
            </div>
            <div class="status-row" data-key="address">
              <span>Address</span><div id="addressStatus">-</div>
            </div>
            <div class="status-row" data-key="chain">
              <span>Chain</span><div id="chainStatus">-</div>
            </div>
            <div class="status-row" data-key="siwe">
              <span>SIWE Token</span><div id="tokenStatus" class="copyable" title="点击复制">-</div>
            </div>
            <div class="status-row" data-key="ucan-session">
              <span>UCAN Session</span><div id="ucanSessionStatus">-</div>
            </div>
            <div class="status-row" data-key="ucan-token">
              <span>UCAN Token</span><div id="ucanTokenStatus" class="copyable" title="点击复制">-</div>
            </div>
            <div class="status-row" data-key="webdav">
              <span>WebDAV App Dir</span><div id="webdavDirStatus">-</div>
            </div>
          </div>
        </div>
      </div>
      <div class="tab-content" data-tab="siwe">
        <div class="section">
          <div class="hint">单后端 SIWE + JWT 登录流程。</div>
          <div class="row">
            <div class="field">
              <label for="baseUrl">Auth Base URL</label>
              <select id="baseUrl"></select>
            </div>
            <div class="field">
              <label for="protectedUrl">Protected API URL</label>
              <input id="protectedUrl" value="http://127.0.0.1:3203/api/v1/public/profile" />
            </div>
          </div>
          <div class="row">
            <button id="loginBtn" class="step-btn" data-step="1" title="请求 challenge 并用钱包签名完成登录">Login</button>
            <button id="profileBtn" class="outline step-btn" data-step="2" title="带 access token 调用受保护接口">Call Profile</button>
            <button id="refreshBtn" class="outline step-btn" data-step="3" title="使用 refresh cookie 刷新 access token">Refresh Token</button>
            <button id="logoutBtn" class="secondary step-btn" data-step="4" title="清理 refresh cookie 并退出登录">Logout</button>
          </div>
        </div>
        <div class="status-slot" data-status-slot="siwe"></div>
      </div>

      <div class="tab-content" data-tab="ucan-multi">
        <div class="section">
          <div class="hint">一次 Root UCAN 授权后，可为多个后端生成 Invocation UCAN。</div>
          <div class="row">
            <div class="field">
              <label for="ucanAud">UCAN Audience</label>
              <input id="ucanAud" value="did:web:127.0.0.1:3203" />
            </div>
            <div class="field">
              <label for="ucanResource">UCAN Resource</label>
              <input id="ucanResource" value="profile" />
            </div>
            <div class="field">
              <label for="ucanAction">UCAN Action</label>
              <input id="ucanAction" value="read" />
            </div>
          </div>
          <div class="row">
            <button id="ucanSessionBtn" class="secondary step-btn" data-step="1" title="从钱包获取 UCAN Session Key">Init UCAN Session</button>
            <button id="ucanRootBtn" class="outline step-btn" data-step="2" title="用 SIWE 生成 Root UCAN（包含能力）">Create Root UCAN</button>
            <button id="ucanProfileBtn" class="step-btn" data-step="3" title="为单个后端生成 Invocation UCAN 并调用">Call UCAN Profile</button>
            <button id="ucanAllBtn" class="outline step-btn" data-step="3" title="遍历所有后端生成 Invocation UCAN 并调用">Call UCAN All</button>
            <button id="ucanLogoutBtn" class="secondary step-btn" data-step="4" title="清理 UCAN Session/Root">Logout</button>
          </div>

          <h3>Backends</h3>
          <div class="backend-grid" id="backendList"></div>
        </div>
        <div class="status-slot" data-status-slot="ucan-multi"></div>
      </div>

      <div class="tab-content" data-tab="ucan-dapp">
        <div class="section">
          <div class="hint">单后端 UCAN 登录，并与 WebDAV 共享 Session/Root。</div>
          <div class="row">
            <div class="field">
              <label for="dappBackend">DAPP Backend</label>
              <select id="dappBackend"></select>
            </div>
            <div class="field">
              <label for="dappProtectedUrl">Backend API URL</label>
              <input id="dappProtectedUrl" value="http://127.0.0.1:3203/api/v1/public/profile" />
            </div>
            <div class="field">
              <label for="dappAud">Backend Audience</label>
              <input id="dappAud" value="did:web:127.0.0.1:3203" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label for="dappResource">Backend Resource</label>
              <input id="dappResource" value="profile" />
            </div>
            <div class="field">
              <label for="dappAction">Backend Action</label>
              <input id="dappAction" value="read" />
            </div>
            <div class="field">
              <label> </label>
              <div class="note">Session/Root 共享给后端与 WebDAV。</div>
            </div>
          </div>
          <div class="row">
            <button id="dappSessionBtn" class="secondary step-btn" data-step="1" title="从钱包获取 UCAN Session Key">Init UCAN Session</button>
            <button id="dappRootBtn" class="outline step-btn" data-step="2" title="用 SIWE 生成 Root UCAN（共享给后端/WebDAV）">Create Root UCAN</button>
            <button id="dappLoginBtn" class="step-btn" data-step="3" title="生成 Invocation UCAN 并初始化 WebDAV">DAPP Login</button>
            <button id="dappProfileBtn" class="outline step-btn" data-step="4" title="调用后端接口或 WebDAV 存储操作">Call Backend</button>
            <button id="dappLogoutBtn" class="secondary step-btn" data-step="5" title="清理 UCAN Session/Root 与 WebDAV 状态">Logout</button>
          </div>
        </div>

          <div class="section">
          <h2>WebDAV 存储（UCAN）</h2>
          <div class="hint">使用 UCAN token 访问 WebDAV（需服务端开启 UCAN）；首次操作会自动创建应用目录。资源建议用 app:&lt;appId&gt;，appId 建议使用前端域名或 IP:端口。</div>
          <div class="row">
            <div class="field">
              <label for="webdavBase">WebDAV Base URL</label>
              <input id="webdavBase" value="http://127.0.0.1:6065" />
            </div>
            <div class="field">
              <label for="webdavPrefix">WebDAV Prefix</label>
              <input id="webdavPrefix" value="/" />
            </div>
            <div class="field">
              <label for="webdavAud">WebDAV Audience</label>
              <input id="webdavAud" value="did:web:127.0.0.1:6065" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label for="webdavResource">WebDAV Resource（推荐 app:&lt;appId&gt;，不要用 app:*）</label>
              <input id="webdavResource" value="app:127.0.0.1:8001" />
            </div>
            <div class="field">
              <label for="webdavAction">WebDAV Action</label>
              <input id="webdavAction" value="write" />
            </div>
            <div class="field">
              <label for="webdavAppId">App ID（推荐前端域名或 IP:端口，映射为 /apps/&lt;appId&gt;）</label>
              <input id="webdavAppId" value="127.0.0.1:8001" />
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label for="webdavPath">File Path</label>
              <input id="webdavPath" value="hello.txt" />
            </div>
            <div class="field">
              <label for="webdavContent">Content</label>
              <input id="webdavContent" value="Hello WebDAV" />
            </div>
          </div>
          <div class="row">
            <button id="webdavListBtn" class="outline">List</button>
            <button id="webdavUploadBtn">Upload</button>
            <button id="webdavDownloadBtn" class="outline">Download</button>
            <button id="webdavDeleteBtn" class="secondary">Delete</button>
          </div>
        </div>
        <div class="status-slot" data-status-slot="ucan-dapp"></div>
      </div>

      <div class="note" id="note">
        当前页面为 Demo。切换到对应 Tab 后按步骤操作即可。
      </div>

      </div>
      </div>
      <div class="log-pane">
        <h3>Log</h3>
        <pre id="log"></pre>
      </div>
    </div>
    </div>

    <script>
      const noteEl = document.getElementById('note');
      const logEl = document.getElementById('log');

      function appendLog(message, data) {
        const line = `[${new Date().toLocaleTimeString()}] ${message}`;
        logEl.textContent += `${line}\n`;
        if (data !== undefined) {
          logEl.textContent += `${JSON.stringify(data, null, 2)}\n`;
        }
        logEl.scrollTop = logEl.scrollHeight;
      }

      appendLog(
        '说明：请先执行 npm run build，确保 dist/web3-bs.umd.js 存在。' +
          ' 建议通过后端端口打开（如 http://127.0.0.1:3203/dapp.html），以便同源 Cookie 刷新。' +
          ' 若使用静态服务器，请确保 http://127.0.0.1:8001/examples/frontend/dapp.html 可访问且 /dist/web3-bs.umd.js 存在。' +
          ' 点击 Token 即可复制完整值。' +
          ' 若提示 No provider found，请确认安装 YeYing 钱包扩展并允许该站点访问。'
      );

      function resolveSdkCandidates() {
        const params = new URLSearchParams(window.location.search);
        const override = params.get('sdk');
        const candidates = [];
        if (override) candidates.push(override);
        if (location && location.origin && location.origin !== 'null') {
          candidates.push(`${location.origin}/dist/web3-bs.umd.js`);
        }
        candidates.push('/dist/web3-bs.umd.js');
        [3203, 3201, 3202, 3204].forEach(port => {
          candidates.push(`http://127.0.0.1:${port}/dist/web3-bs.umd.js`);
        });
        return candidates;
      }

      function loadSdk() {
        const candidates = resolveSdkCandidates();
        return new Promise((resolve, reject) => {
          let index = 0;
          const next = () => {
            if (index >= candidates.length) {
              reject(new Error('Failed to load SDK'));
              return;
            }
            const url = candidates[index++];
            if (!url) return next();
            const script = document.createElement('script');
            script.src = url;
            script.async = true;
            script.onload = () => resolve(url);
            script.onerror = () => next();
            document.head.appendChild(script);
          };
          next();
        });
      }

      function initApp(sdkUrl) {
        appendLog('SDK loaded', { sdkUrl });

        const providerStatus = document.getElementById('providerStatus');
        const addressStatus = document.getElementById('addressStatus');
        const chainStatus = document.getElementById('chainStatus');
        const tokenStatus = document.getElementById('tokenStatus');
        const ucanSessionStatus = document.getElementById('ucanSessionStatus');
        const ucanTokenStatus = document.getElementById('ucanTokenStatus');
        const backendListEl = document.getElementById('backendList');
        const baseUrlInput = document.getElementById('baseUrl');
        const protectedUrlInput = document.getElementById('protectedUrl');
        const ucanAudInput = document.getElementById('ucanAud');
        const ucanResourceInput = document.getElementById('ucanResource');
        const ucanActionInput = document.getElementById('ucanAction');
        const dappBackendInput = document.getElementById('dappBackend');
        const dappProtectedUrlInput = document.getElementById('dappProtectedUrl');
        const dappAudInput = document.getElementById('dappAud');
        const dappResourceInput = document.getElementById('dappResource');
        const dappActionInput = document.getElementById('dappAction');
        const webdavBaseInput = document.getElementById('webdavBase');
        const webdavPrefixInput = document.getElementById('webdavPrefix');
        const webdavAudInput = document.getElementById('webdavAud');
        const webdavResourceInput = document.getElementById('webdavResource');
        const webdavActionInput = document.getElementById('webdavAction');
        const webdavAppIdInput = document.getElementById('webdavAppId');
        const webdavPathInput = document.getElementById('webdavPath');
        const webdavContentInput = document.getElementById('webdavContent');
        const webdavDirStatus = document.getElementById('webdavDirStatus');
        const tabButtons = Array.from(document.querySelectorAll('.tab-button'));
        const tabContents = Array.from(document.querySelectorAll('.tab-content'));
        const statusRows = Array.from(document.querySelectorAll('.status-row'));
        const statusPanel = document.getElementById('statusPanel');

        const detectBtn = document.getElementById('detectBtn');
        const connectBtn = document.getElementById('connectBtn');
        const loginBtn = document.getElementById('loginBtn');
        const profileBtn = document.getElementById('profileBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const ucanSessionBtn = document.getElementById('ucanSessionBtn');
        const ucanRootBtn = document.getElementById('ucanRootBtn');
        const ucanProfileBtn = document.getElementById('ucanProfileBtn');
        const ucanAllBtn = document.getElementById('ucanAllBtn');
        const ucanLogoutBtn = document.getElementById('ucanLogoutBtn');
        const dappSessionBtn = document.getElementById('dappSessionBtn');
        const dappRootBtn = document.getElementById('dappRootBtn');
        const dappLoginBtn = document.getElementById('dappLoginBtn');
        const dappProfileBtn = document.getElementById('dappProfileBtn');
        const dappLogoutBtn = document.getElementById('dappLogoutBtn');
        const webdavListBtn = document.getElementById('webdavListBtn');
        const webdavUploadBtn = document.getElementById('webdavUploadBtn');
        const webdavDownloadBtn = document.getElementById('webdavDownloadBtn');
        const webdavDeleteBtn = document.getElementById('webdavDeleteBtn');

        let currentToken = null;
        let ucanSession = null;
        let ucanRoot = null;
        let currentUcanToken = null;
        let webdavToken = null;
        let webdavClient = null;
        let webdavAppDir = null;

        const backendConfigs = [
          {
            id: 'go',
            name: 'Go Backend',
            port: 3201,
            baseUrl: 'http://127.0.0.1:3201/api/v1/public/auth',
            protectedUrl: 'http://127.0.0.1:3201/api/v1/public/profile',
            ucanAud: 'did:web:127.0.0.1:3201',
          },
          {
            id: 'java',
            name: 'Java Backend',
            port: 3202,
            baseUrl: 'http://127.0.0.1:3202/api/v1/public/auth',
            protectedUrl: 'http://127.0.0.1:3202/api/v1/public/profile',
            ucanAud: 'did:web:127.0.0.1:3202',
          },
          {
            id: 'node',
            name: 'Node Backend',
            port: 3203,
            baseUrl: 'http://127.0.0.1:3203/api/v1/public/auth',
            protectedUrl: 'http://127.0.0.1:3203/api/v1/public/profile',
            ucanAud: 'did:web:127.0.0.1:3203',
          },
          {
            id: 'python',
            name: 'Python Backend',
            port: 3204,
            baseUrl: 'http://127.0.0.1:3204/api/v1/public/auth',
            protectedUrl: 'http://127.0.0.1:3204/api/v1/public/profile',
            ucanAud: 'did:web:127.0.0.1:3204',
          },
        ];

        function renderAuthOptions() {
          baseUrlInput.textContent = '';
          backendConfigs.forEach(config => {
            const option = document.createElement('option');
            option.value = config.baseUrl;
            option.textContent = `${config.name} (${config.port})`;
            baseUrlInput.appendChild(option);
          });
        }

        function renderDappOptions() {
          if (!dappBackendInput) return;
          dappBackendInput.textContent = '';
          backendConfigs.forEach(config => {
            const option = document.createElement('option');
            option.value = config.id;
            option.textContent = `${config.name} (${config.port})`;
            dappBackendInput.appendChild(option);
          });
        }

        function findBackendByBaseUrl(value) {
          return backendConfigs.find(config => config.baseUrl === value);
        }

        function findBackendById(id) {
          return backendConfigs.find(config => config.id === id);
        }

        function findBackendByOrigin(origin) {
          if (!origin) return null;
          return backendConfigs.find(config => config.baseUrl.startsWith(origin));
        }

        function log(message, data) {
          appendLog(message, data);
        }

      let provider = null;

      function ensureSDK() {
        if (!window.YeYingWeb3) {
          log('SDK not loaded. Run npm run build first.');
          return false;
        }
        return true;
      }

      async function syncWalletStatus(nextProvider, options = {}) {
        if (!nextProvider) {
          providerStatus.textContent = 'Not detected';
          addressStatus.textContent = '-';
          chainStatus.textContent = '-';
          return;
        }
        providerStatus.textContent = nextProvider.isYeYing ? 'YeYing Provider' : 'Injected Provider';
        const { getAccounts, requestAccounts, getChainId } = window.YeYingWeb3;
        let accounts = await getAccounts(nextProvider);
        if (accounts.length === 0 && options.requestIfEmpty) {
          accounts = await requestAccounts({ provider: nextProvider });
        }
        addressStatus.textContent = accounts[0] || '-';
        const chainId = await getChainId(nextProvider);
        chainStatus.textContent = chainId || '-';
      }

      function setActiveTab(tabId) {
        tabButtons.forEach(button => {
          const active = button.dataset.tab === tabId;
          button.classList.toggle('active', active);
        });
        tabContents.forEach(panel => {
          const active = panel.dataset.tab === tabId;
          panel.classList.toggle('active', active);
        });
        updateStatusVisibility(tabId);
        moveStatusPanel(tabId);
      }

      function updateStatusVisibility(tabId) {
        const visibilityMap = {
          wallet: ['provider', 'address', 'chain'],
          siwe: ['provider', 'address', 'chain', 'siwe'],
          'ucan-multi': ['provider', 'address', 'chain', 'ucan-session', 'ucan-token'],
          'ucan-dapp': ['provider', 'address', 'chain', 'ucan-session', 'ucan-token', 'webdav'],
        };
        const visibleKeys = new Set(visibilityMap[tabId] || []);
        statusRows.forEach(row => {
          const key = row.dataset.key || '';
          row.classList.toggle('hidden', !visibleKeys.has(key));
        });
      }

      function moveStatusPanel(tabId) {
        if (!statusPanel) return;
        const slot = document.querySelector(`.tab-content[data-tab="${tabId}"] .status-slot`);
        if (slot && statusPanel.parentElement !== slot) {
          slot.appendChild(statusPanel);
        }
      }

      function shortenToken(token) {
        if (!token) return '-';
        if (token.length <= 16) return token;
        return `${token.slice(0, 6)}...${token.slice(-6)}`;
      }

      function updateTokenStatus() {
        if (!window.YeYingWeb3?.getAccessToken) return;
        currentToken = window.YeYingWeb3.getAccessToken({ storeToken: false });
        tokenStatus.textContent = shortenToken(currentToken);
        tokenStatus.title = currentToken ? '点击复制' : '-';
      }

      function updateUcanStatus() {
        ucanSessionStatus.textContent = ucanSession?.did || '-';
        ucanTokenStatus.textContent = shortenToken(currentUcanToken);
        ucanTokenStatus.title = currentUcanToken ? '点击复制' : '-';
      }

      function updateWebdavStatus() {
        if (!webdavDirStatus) return;
        webdavDirStatus.textContent = webdavAppDir || '-';
      }

      function makeCap(resource, action) {
        const res = (resource || '').trim();
        const act = (action || '').trim();
        if (!res || !act) return null;
        return { resource: res, action: act };
      }

      function sanitizeAppId(appId) {
        return (appId || '').trim().replace(/[^a-zA-Z0-9._-]/g, '-');
      }

      function buildAppCap(appId, action) {
        const sanitized = sanitizeAppId(appId);
        if (!sanitized) return null;
        const act = (action || '').trim() || 'write';
        return makeCap(`app:${sanitized}`, act);
      }

      function dedupeCaps(caps) {
        const seen = new Set();
        return (caps || []).filter(cap => {
          if (!cap) return false;
          const key = `${cap.resource}|${cap.action}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });
      }

      function resolveCapsFromInputs(resourceInput, actionInput) {
        if (!resourceInput || !actionInput) return [];
        const cap = makeCap(resourceInput.value, actionInput.value);
        return cap ? [cap] : [];
      }

      function resolveUcanCaps() {
        return resolveCapsFromInputs(ucanResourceInput, ucanActionInput);
      }

      function resolveDappCaps() {
        return resolveCapsFromInputs(dappResourceInput, dappActionInput);
      }

      function resolveWebdavCaps() {
        const explicitCap = makeCap(webdavResourceInput.value, webdavActionInput.value);
        if (explicitCap) return [explicitCap];
        const appCap = buildAppCap(webdavAppIdInput.value, webdavActionInput.value);
        if (appCap) return [appCap];
        return resolveDappCaps();
      }

      function resolveDappRootCaps() {
        return dedupeCaps([...resolveDappCaps(), ...resolveWebdavCaps()]);
      }

      function resolveWebdavPath(rawPath) {
        const trimmed = (rawPath || '').trim();
        if (!trimmed) return webdavAppDir || '/';
        if (trimmed.startsWith('/')) return trimmed;
        const base = webdavAppDir && webdavAppDir !== '/' ? webdavAppDir : '';
        return `${base}/${trimmed}`;
      }

      async function ensureUcanSession() {
        const { createUcanSession } = window.YeYingWeb3;
        ucanSession = ucanSession || (await createUcanSession());
        updateUcanStatus();
        return ucanSession;
      }

      async function ensureRootWithCaps(caps, label) {
        const { getOrCreateUcanRoot } = window.YeYingWeb3;
        await ensureUcanSession();
        if (!caps.length) {
          log(label ? `Missing UCAN capabilities (${label})` : 'Missing UCAN capabilities');
          return null;
        }
        provider = provider || (await window.YeYingWeb3.getProvider({ timeoutMs: 3000 }));
        if (!provider) {
          log('No provider');
          return null;
        }
        ucanRoot = await getOrCreateUcanRoot({
          provider,
          session: ucanSession,
          capabilities: caps,
        });
        log(label ? `Root UCAN ready (${label})` : 'Root UCAN ready', ucanRoot);

        updateUcanStatus();
        return ucanRoot;
      }

      async function ensureUcanRoot() {
        return await ensureRootWithCaps(resolveUcanCaps(), 'multi');
      }

      async function ensureDappRoot() {
        return await ensureRootWithCaps(resolveDappRootCaps(), 'dapp');
      }

      async function createInvocationToken(options) {
        const { createInvocationUcan } = window.YeYingWeb3;
        if (!options?.audience) {
          log('Missing UCAN audience');
          return;
        }
        const caps = options.capabilities || [];
        if (!caps.length) {
          log(options.label ? `Missing UCAN capabilities (${options.label})` : 'Missing UCAN capabilities');
          return null;
        }
        const rootCaps = options.rootCaps || caps;
        const root = await ensureRootWithCaps(rootCaps, options.label);
        if (!root) return null;
        currentUcanToken = await createInvocationUcan({
          issuer: ucanSession,
          audience: options.audience,
          capabilities: caps,
          proofs: [root],
        });
        updateUcanStatus();
        return currentUcanToken;
      }

      async function callUcanProtected(target, options = {}) {
        const caps = options.capabilities || resolveUcanCaps();
        const token = await createInvocationToken({
          audience: target.ucanAud,
          capabilities: caps,
          rootCaps: options.rootCaps,
          label: options.label,
        });
        if (!token) return;

        const res = await fetch(target.protectedUrl, {
          method: 'GET',
          headers: {
            Authorization: `Bearer ${token}`,
          },
        });
        let payload = null;
        try {
          payload = await res.json();
        } catch {
          payload = { status: res.status };
        }
        const prefix = options.logPrefix || 'UCAN profile';
        log(`${prefix} (${target.name})`, payload);
      }

      async function ensureWebdavStorage() {
        const { initWebDavStorage } = window.YeYingWeb3;
        const rootCaps = resolveDappRootCaps();
        const webdavCaps = resolveWebdavCaps();
        if (!webdavCaps.length) {
          log('Missing WebDAV capabilities');
          return null;
        }
        provider = provider || (await window.YeYingWeb3.getProvider({ timeoutMs: 3000 }));
        if (!provider) {
          log('No provider');
          return null;
        }
        const result = await initWebDavStorage({
          baseUrl: webdavBaseInput.value,
          prefix: webdavPrefixInput.value,
          audience: webdavAudInput.value,
          appId: webdavAppIdInput.value,
          capabilities: rootCaps.length ? rootCaps : webdavCaps,
          invocationCapabilities: webdavCaps,
          provider,
          session: ucanSession || undefined,
          root: ucanRoot || undefined,
        });
        webdavClient = result.client;
        webdavToken = result.token;
        webdavAppDir = result.appDir;
        ucanSession = result.session;
        ucanRoot = result.root;
        currentUcanToken = webdavToken;
        updateUcanStatus();
        updateWebdavStatus();
        log('WebDAV storage ready', { appDir: webdavAppDir });
        return webdavClient;
      }

      async function getWebdavClient() {
        if (!ensureSDK()) return null;
        return await ensureWebdavStorage();
      }

      async function clearUcanState(options = {}) {
        if (!ensureSDK()) return;
        const { clearUcanSession } = window.YeYingWeb3;
        if (clearUcanSession) {
          try {
            await clearUcanSession();
          } catch (error) {
            log('Clear UCAN session failed', { error: String(error) });
          }
        }
        ucanSession = null;
        ucanRoot = null;
        currentUcanToken = null;
        if (options.clearWebdav) {
          webdavToken = null;
          webdavClient = null;
          webdavAppDir = null;
          updateWebdavStatus();
        }
        updateUcanStatus();
      }

      function applyBackend(config, options = {}) {
        if (!config) return;
        baseUrlInput.value = config.baseUrl;
        protectedUrlInput.value = config.protectedUrl;
        if (options.updateUcan !== false) {
          ucanAudInput.value = config.ucanAud;
        }
        if (!options.silent) {
          log('Backend selected', config);
        }
      }

      function applyDappBackend(config, options = {}) {
        if (!config || !dappBackendInput) return;
        dappBackendInput.value = config.id;
        dappProtectedUrlInput.value = config.protectedUrl;
        dappAudInput.value = config.ucanAud;
        if (!options.silent) {
          log('DAPP backend selected', config);
        }
      }

      function renderBackends() {
        backendListEl.textContent = '';
        backendConfigs.forEach(config => {
          const item = document.createElement('div');
          item.className = 'backend-item';

          const title = document.createElement('h4');
          title.textContent = `${config.name} (${config.port})`;

          const meta = document.createElement('div');
          meta.className = 'meta';
          meta.innerHTML = `
            <div>Auth: <code>${config.baseUrl}</code></div>
            <div>Profile: <code>${config.protectedUrl}</code></div>
            <div>UCAN AUD: <code>${config.ucanAud}</code></div>
          `;

          const button = document.createElement('button');
          button.className = 'outline small';
          button.textContent = 'Use this backend';
          button.addEventListener('click', () => applyBackend(config));

          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(button);
          backendListEl.appendChild(item);
        });
      }

      function setDefaultsFromLocation() {
        if (!location || location.protocol === 'file:') return;
        const origin = location.origin;
        if (!origin) return;
        const matched = findBackendByOrigin(origin);
        if (matched) {
          applyBackend(matched, { silent: true });
          applyDappBackend(matched, { silent: true });
        }
        const fallback = backendConfigs.find(config => config.id === 'node') || backendConfigs[0];
        if (fallback) {
          applyBackend(fallback, { silent: true });
          applyDappBackend(fallback, { silent: true });
        }
        const host = location.host || '';
        if (host) {
          const appIdPlaceholders = ['', '127.0.0.1', '127.0.0.1:8001'];
          if (webdavAppIdInput && appIdPlaceholders.includes(webdavAppIdInput.value)) {
            webdavAppIdInput.value = host;
          }
          const resourcePlaceholders = ['', 'app:127.0.0.1', 'app:127.0.0.1:8001'];
          if (webdavResourceInput && resourcePlaceholders.includes(webdavResourceInput.value)) {
            webdavResourceInput.value = `app:${host}`;
          }
        }
      }

      detectBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { getProvider } = window.YeYingWeb3;
        provider = await getProvider({ timeoutMs: 3000 });
        if (provider) {
          log('Provider detected', { isYeYing: provider.isYeYing, isMetaMask: provider.isMetaMask });
          await syncWalletStatus(provider);
        } else {
          providerStatus.textContent = 'Not detected';
          log('No provider found');
        }
      });

      tabButtons.forEach(button => {
        button.addEventListener('click', () => setActiveTab(button.dataset.tab));
      });

      connectBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { requestAccounts, getChainId, onAccountsChanged, onChainChanged } = window.YeYingWeb3;
        provider = provider || (await window.YeYingWeb3.getProvider({ timeoutMs: 3000 }));
        if (!provider) return log('No provider');

        const accounts = await requestAccounts({ provider });
        addressStatus.textContent = accounts[0] || '-';
        const chainId = await getChainId(provider);
        chainStatus.textContent = chainId || '-';
        log('Connected', { accounts, chainId });

        onAccountsChanged(provider, (next) => {
          addressStatus.textContent = next[0] || '-';
          log('accountsChanged', next);
        });

        onChainChanged(provider, (next) => {
          chainStatus.textContent = next;
          log('chainChanged', next);
        });
      });

      loginBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { loginWithChallenge } = window.YeYingWeb3;
        provider = provider || (await window.YeYingWeb3.getProvider({ timeoutMs: 3000 }));
        if (!provider) return log('No provider');

        await syncWalletStatus(provider, { requestIfEmpty: true });
        const login = await loginWithChallenge({
          provider,
          baseUrl: baseUrlInput.value,
          storeToken: false,
        });

        updateTokenStatus();
        log('Login success', login);
      });

      profileBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { authFetch } = window.YeYingWeb3;

        const res = await authFetch(protectedUrlInput.value, { method: 'GET' }, {
          baseUrl: baseUrlInput.value,
          storeToken: false,
        });

        let payload = null;
        try {
          payload = await res.json();
        } catch {
          payload = { status: res.status };
        }

        log('Profile response', payload);
        updateTokenStatus();
      });

      refreshBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { refreshAccessToken } = window.YeYingWeb3;

        const result = await refreshAccessToken({
          baseUrl: baseUrlInput.value,
          storeToken: false,
        });

        updateTokenStatus();
        log('Refresh success', result);
      });

      logoutBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const { logout } = window.YeYingWeb3;

        const result = await logout({
          baseUrl: baseUrlInput.value,
          storeToken: false,
        });

        updateTokenStatus();
        log('Logout', result);
      });

      ucanSessionBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await ensureUcanSession();
        log('UCAN session ready', ucanSession);
      });

      ucanRootBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await ensureUcanRoot();
      });

      ucanProfileBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await callUcanProtected({
          name: 'Custom',
          protectedUrl: protectedUrlInput.value,
          ucanAud: ucanAudInput.value,
        });
      });

      ucanAllBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        for (const config of backendConfigs) {
          await callUcanProtected(config);
        }
      });

      ucanLogoutBtn.addEventListener('click', async () => {
        await clearUcanState({ clearWebdav: true });
        log('UCAN logout');
      });

      dappSessionBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await ensureUcanSession();
        log('DAPP UCAN session ready', ucanSession);
      });

      dappRootBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await ensureDappRoot();
      });

      dappLoginBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const caps = resolveDappCaps();
        const token = await createInvocationToken({
          audience: dappAudInput.value,
          capabilities: caps,
          rootCaps: resolveDappRootCaps(),
          label: 'dapp',
        });
        if (token) {
          log('DAPP UCAN token ready', { audience: dappAudInput.value });
        }
        try {
          await ensureWebdavStorage();
        } catch (error) {
          log('WebDAV init failed', { error: String(error) });
        }
      });

      dappProfileBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        await callUcanProtected({
          name: 'DAPP Backend',
          protectedUrl: dappProtectedUrlInput.value,
          ucanAud: dappAudInput.value,
        }, {
          capabilities: resolveDappCaps(),
          rootCaps: resolveDappRootCaps(),
          label: 'dapp',
          logPrefix: 'DAPP profile',
        });
      });

      dappLogoutBtn.addEventListener('click', async () => {
        await clearUcanState({ clearWebdav: true });
        log('DAPP logout');
      });

      webdavListBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const client = await getWebdavClient();
        if (!client) return;
        const targetPath = webdavAppDir || '/';
        const listing = await client.listDirectory(targetPath);
        log('WebDAV list', { path: targetPath, listing });
      });

      webdavUploadBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const client = await getWebdavClient();
        if (!client) return;
        const path = resolveWebdavPath(webdavPathInput.value);
        await client.upload(path, webdavContentInput.value);
        log('WebDAV upload ok', { path });
      });

      webdavDownloadBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const client = await getWebdavClient();
        if (!client) return;
        const path = resolveWebdavPath(webdavPathInput.value);
        const content = await client.downloadText(path);
        log('WebDAV download', { path, content });
      });

      webdavDeleteBtn.addEventListener('click', async () => {
        if (!ensureSDK()) return;
        const client = await getWebdavClient();
        if (!client) return;
        const path = resolveWebdavPath(webdavPathInput.value);
        await client.remove(path);
        log('WebDAV delete ok', { path });
      });

      async function copyToken() {
        if (!currentToken) return;
        try {
          await navigator.clipboard.writeText(currentToken);
          log('Token copied');
        } catch (error) {
          try {
            const input = document.createElement('textarea');
            input.value = currentToken;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            input.remove();
            log('Token copied');
          } catch (fallbackError) {
            log('Copy failed', fallbackError);
          }
        }
      }

      tokenStatus.addEventListener('click', copyToken);

      async function copyUcanToken() {
        if (!currentUcanToken) return;
        try {
          await navigator.clipboard.writeText(currentUcanToken);
          log('UCAN token copied');
        } catch (error) {
          try {
            const input = document.createElement('textarea');
            input.value = currentUcanToken;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            input.remove();
            log('UCAN token copied');
          } catch (fallbackError) {
            log('Copy failed', fallbackError);
          }
        }
      }

      ucanTokenStatus.addEventListener('click', copyUcanToken);

      baseUrlInput.addEventListener('change', () => {
        const selected = findBackendByBaseUrl(baseUrlInput.value);
        if (selected) {
          applyBackend(selected, { updateUcan: false });
        }
      });

      if (dappBackendInput) {
        dappBackendInput.addEventListener('change', () => {
          const selected = findBackendById(dappBackendInput.value);
          if (selected) {
            applyDappBackend(selected);
          }
        });
      }

      renderAuthOptions();
      renderDappOptions();
      const defaultBackend = backendConfigs.find(config => config.id === 'node') || backendConfigs[0];
      if (defaultBackend) {
        applyBackend(defaultBackend, { silent: true });
        applyDappBackend(defaultBackend, { silent: true });
      }
      renderBackends();
      setDefaultsFromLocation();
      const initialTab = document.querySelector('.tab-button.active')?.dataset.tab || 'wallet';
      updateStatusVisibility(initialTab);
      moveStatusPanel(initialTab);

      if (location.protocol === 'file:') {
        noteEl.textContent =
          '当前为 file:// 打开。扩展通常不会注入 provider。请使用本地服务器打开该页面，或在扩展设置中允许访问文件 URL。';
      }
      }

      loadSdk()
        .then(initApp)
        .catch(error => {
          noteEl.textContent =
            'SDK 加载失败。请先运行 npm run build 并确保 dist/web3-bs.umd.js 可访问。' +
            '也可通过 ?sdk=http://127.0.0.1:3203/dist/web3-bs.umd.js 指定 SDK 地址。';
          appendLog('SDK load failed', { error: String(error) });
        });
    </script>
  </body>
</html>
